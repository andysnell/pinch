name: "Build and Push Docker Images"

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build from (tag or branch name, e.g., v0.0.1, main, feature/xyz)"
        required: true
        default: "main"
        type: string
  workflow_call:
    inputs:
      ref:
        description: "Git ref to build from (tag or branch name, e.g., v0.0.1, main, feature/xyz)"
        required: true
        type: string
      docker_tag:
        description: "Override Docker tag (optional - if not provided, will be derived from ref)"
        required: false
        type: string
      always_latest:
        description: "Always tag as latest regardless of ref"
        required: false
        type: boolean
        default: false

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    if: github.repository == 'phoneburner/pinch'
    strategy:
      matrix:
        image:
          - target: pinch-php
            suffix: php
          - target: pinch-web
            suffix: web
          - target: pinch-prettier
            suffix: prettier

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Determine image tags
        id: tags
        run: |
          REF="${{ inputs.ref }}"

          # Use provided docker_tag or derive from ref
          if [ -n "${{ inputs.docker_tag }}" ]; then
            DOCKER_TAG="${{ inputs.docker_tag }}"
            echo "ðŸ·ï¸ Using provided Docker tag: $DOCKER_TAG"
          else
            # Sanitize ref for use as Docker tag (replace / with -)
            DOCKER_TAG=$(echo "$REF" | sed 's/\//-/g')
            echo "ðŸ·ï¸ Derived Docker tag from ref: $DOCKER_TAG"
          fi

          echo "ðŸ·ï¸ Building from ref: $REF"
          echo "ðŸ³ Docker tag: $DOCKER_TAG"

          # Check if we should also tag as latest
          INCLUDE_LATEST="${{ inputs.always_latest }}"

          if [ "$INCLUDE_LATEST" != "true" ]; then
            # Get the SHA of the checked out ref
            CURRENT_SHA=$(git rev-parse HEAD)
            echo "ðŸ“ Current SHA: $CURRENT_SHA"

            # Get the SHA of main branch HEAD
            MAIN_SHA=$(git rev-parse origin/main)
            echo "ðŸ“ Main branch SHA: $MAIN_SHA"

            if [ "$CURRENT_SHA" = "$MAIN_SHA" ]; then
              echo "âœ… Current ref points to main branch HEAD - will also tag as 'latest'"
              INCLUDE_LATEST="true"
            else
              echo "â„¹ï¸ Current ref does not point to main branch HEAD - skipping 'latest' tag"
              INCLUDE_LATEST="false"
            fi
          else
            echo "âœ… Always latest flag is set - will tag as 'latest'"
          fi

          # Parse semver versions for additional tagging
          SEMVER_TAGS=""
          CLEAN_TAG=$(echo "$DOCKER_TAG" | sed 's/^v//')

          if echo "$CLEAN_TAG" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ðŸ”¢ Detected semver version: $CLEAN_TAG"
            
            if [ "$INCLUDE_LATEST" = "true" ]; then
              MAJOR=$(echo "$CLEAN_TAG" | cut -d. -f1)
              MINOR=$(echo "$CLEAN_TAG" | cut -d. -f1-2)
              
              echo "ðŸ“Œ Additional semver tags: $MAJOR, $MINOR"
              SEMVER_TAGS="
            ghcr.io/${{ github.repository }}-${{ matrix.image.suffix }}:$MAJOR
            ghcr.io/${{ github.repository }}-${{ matrix.image.suffix }}:$MINOR"
            else
              echo "â„¹ï¸ Semver detected but include_latest=false, using only full version"
            fi
          else
            echo "â„¹ï¸ Not a semver version, skipping additional tags"
          fi

          echo "docker_tag=$DOCKER_TAG" >> $GITHUB_OUTPUT
          echo "clean_tag=$CLEAN_TAG" >> $GITHUB_OUTPUT
          echo "include_latest=$INCLUDE_LATEST" >> $GITHUB_OUTPUT
          echo "semver_tags<<EOF" >> $GITHUB_OUTPUT
          echo "$SEMVER_TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Image - ${{ matrix.image.target }}
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          file: Dockerfile
          target: ${{ matrix.image.target }}
          tags: |
            ghcr.io/${{ github.repository }}-${{ matrix.image.suffix }}:${{ steps.tags.outputs.clean_tag }}
            ${{ steps.tags.outputs.include_latest == 'true' && format('ghcr.io/{0}-{1}:latest', github.repository, matrix.image.suffix) || '' }}${{ steps.tags.outputs.semver_tags }}
          cache-from: type=gha,scope=${{ github.repository }}-${{ matrix.image.suffix }}
          cache-to: type=gha,scope=${{ github.repository }}-${{ matrix.image.suffix }},mode=max
          pull: true
          push: true

      - name: Summary
        run: |
          echo "## ðŸ³ Docker Image Built and Pushed - ${{ matrix.image.target }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reference:** \`${{ inputs.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Tag:** \`${{ steps.tags.outputs.docker_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image:" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository }}-${{ matrix.image.suffix }}:${{ steps.tags.outputs.clean_tag }}\`" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.tags.outputs.include_latest }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Also tagged as \`latest\`:" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ github.repository }}-${{ matrix.image.suffix }}:latest\`" >> $GITHUB_STEP_SUMMARY
            
            # Add semver tags if they exist
            if [ -n "${{ steps.tags.outputs.semver_tags }}" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Additional semver tags:" >> $GITHUB_STEP_SUMMARY
              echo "${{ steps.tags.outputs.semver_tags }}" | grep -v '^$' | sed 's/^/- `/' | sed 's/$/`/' >> $GITHUB_STEP_SUMMARY
            fi
          fi
